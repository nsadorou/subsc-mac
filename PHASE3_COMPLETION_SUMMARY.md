# Phase 3: 通知機能 - 完了報告

## 概要
Phase 3では、サブスクリプション管理アプリの通知機能を実装しました。ユーザーが設定したタイミングで更新前通知を受け取れるようになりました。

## 実装した機能

### Phase 3-1: 通知権限とセットアップ ✅
- **NotificationManager.swift**: 通知管理の中核サービス
  - UNUserNotificationCenter の初期化と権限管理
  - 通知権限のステータス監視（@Published プロパティ）
  - 権限要求機能
  - UNUserNotificationCenterDelegate の実装

- **SubscriptionManagerApp.swift**: アプリ起動時の通知設定
  - NotificationManager の初期化とDI
  - UNUserNotificationCenter delegate の設定
  - 起動時の通知更新処理

- **NotificationPermissionView.swift**: 通知権限要求UI
  - 通知許可状況の可視化
  - ユーザーフレンドリーな権限要求インターフェース
  - システム設定への誘導機能

### Phase 3-2: 通知スケジューリング ✅
- **Core Data モデル更新**: 通知関連属性の追加
  - `notificationTimings`: 通知タイミング設定（複数選択対応）
  - `notificationTime`: 通知時刻設定

- **通知スケジューリングロジック**:
  - 次回更新日の自動計算（月次・年次サイクル対応）
  - 通知タイミングに基づく通知日時計算
  - UNCalendarNotificationTrigger を使用した正確な通知スケジューリング
  - 通知コンテンツの動的生成（サービス名、金額、通貨を含む）

- **通知管理機能**:
  - 個別サブスクリプションの通知設定/削除
  - 全サブスクリプションの一括通知更新
  - アプリ起動時の通知自動更新

### Phase 3-3: 通知設定UI ✅
- **AddEditSubscriptionView.swift**: サブスクリプション編集時の通知設定
  - 通知タイミング選択（1日前、3日前、1週間前、2週間前）
  - 複数タイミング同時選択対応
  - 通知時刻のカスタマイズ
  - 通知プレビュー機能（テスト通知送信）

- **NotificationSettingsView.swift**: 詳細通知設定画面
  - グローバル通知設定の管理
  - デフォルト通知設定の管理
  - 予定されている通知の一覧表示
  - テスト通知送信機能

- **SettingsView.swift**: 設定画面への統合
  - 通知権限状態の表示
  - 詳細設定画面への導線

### Phase 3-4: バックグラウンド処理とログ機能 ✅
- **AppLogger.swift**: 包括的なログ機能
  - 5段階のログレベル（DEBUG, INFO, WARNING, ERROR, CRITICAL）
  - ファイルベースのログ保存
  - 自動ログローテーション（7日間保持）
  - ログエクスポート機能

- **BackgroundTaskManager.swift**: バックグラウンド処理管理
  - 定期的な通知更新（1時間間隔）
  - ユーザー設定によるバックグラウンド処理制御
  - 手動更新機能

- **DebugLogView.swift**: デバッグ・ログ表示UI
  - リアルタイムログ表示
  - ログレベルフィルタリング
  - 自動更新機能
  - ログエクスポート・クリア機能

- **アプリ全体のログ統合**:
  - NotificationManager の主要操作にログ追加
  - エラーハンドリングの改善
  - デバッグ情報の可視化

## 技術的特徴

### 通知システム
- **正確な日時計算**: Calendar API を使用した正確な更新日・通知日計算
- **柔軟な設定**: 複数通知タイミング、カスタム通知時刻対応
- **ユーザーエクスペリエンス**: 直感的な設定UI、プレビュー機能

### アーキテクチャ
- **MVVM パターン**: ObservableObject を活用した状態管理
- **シングルトンパターン**: NotificationManager, AppLogger の共有インスタンス
- **依存性注入**: environmentObject を使用したサービス注入

### エラーハンドリング・デバッグ
- **包括的ログ**: 操作の詳細な記録と追跡
- **エラー分析**: 分類されたログレベルによる問題診断
- **運用支援**: バックグラウンド処理の監視と制御

## 設定可能な通知オプション

### 通知タイミング
- 1日前
- 3日前  
- 1週間前
- 2週間前
- 複数選択可能

### 通知設定
- カスタム通知時刻
- サービス別個別設定
- グローバル通知有効/無効
- テスト通知機能

## セキュリティ・プライバシー考慮事項
- 適切な通知権限要求フロー
- ローカル通知のみ使用（外部サーバー不要）
- サンドボックス環境での動作
- ユーザー制御可能な通知設定

## 今後の拡張可能性
- プッシュ通知対応
- 通知カテゴリの追加
- 通知アクション（直接更新、延期など）
- カスタム通知サウンド
- 通知統計・分析機能

Phase 3 の通知機能実装により、ユーザーはサブスクリプションの更新を見逃すことなく、効率的に管理できるようになりました。